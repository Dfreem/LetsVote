@page "/game"
@using LetsVote.Client.Components
@using LetsVote.Client.Services.Toast
@using LetsVote.Shared.DTO
@using Microsoft.AspNetCore.SignalR.Client
@using System.Timers
@inject NavigationManager _nav
@inject IToastService _toast

<PageTitle>Tug of War Game</PageTitle>

<div class="container text-center">
    <h1>Voting Game</h1>

    <!-- Game Area with Team Images -->
    <div class="game-area my-4 position-relative">
        <!-- Team A on the left -->
        <div class="team team-a" style="left:@(50 + PositionOffset - 25)%;">
            <img src="images/teamA.png" alt="Team A" class="team-image img-fluid" />
            <p>Team A: @TeamAVotes</p>
        </div>

        <!-- Rope in the center -->
        <div class="rope" style="left:@(50 + PositionOffset)%;">
            <img src="images/rope.png" alt="Rope" class="rope-image img-fluid" />
        </div>

        <!-- Team B on the right -->
        <div class="team team-b" style="left:@(50 + PositionOffset + 25)%;">
            <img src="images/teamB.png" alt="Team B" class="team-image img-fluid" />
            <p>Team B: @TeamBVotes</p>
        </div>
    </div>

    <!-- Monster Attack Section -->
    <div class="monster-area">
        @if (!IsStunned && !IsMonsterDefeated)
        {
            <div class="monster-image" style="position:absolute; top:-50px; @GetMonsterPosition(CorrectButton)">
                <img src="images/monster.png" alt="Monster" />
            </div>
        }
        else if (IsStunned)
        {
            <p>You're stunned! Wait for a few seconds...</p>
        }
    </div>

    <!-- Monster Fight Button Area -->
    <div class="button-area my-4">
        <button class="btn btn-danger" @onclick="@(() => ButtonClicked("A"))" disabled="@IsStunned">A</button>
        <button class="btn btn-warning" @onclick="@(() => ButtonClicked("B"))" disabled="@IsStunned">B</button>
        <button class="btn btn-success" @onclick="@(() => ButtonClicked("C"))" disabled="@IsStunned">C</button>
    </div>

    <!-- Success Message Section -->
    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success my-4">
            <p>@SuccessMessage</p>
        </div>
    }



    <!-- Display the Vote Counts -->
    <div class="vote-counts my-4">
        <p>Team A Votes: @TeamAVotes</p>
        <p>Team B Votes: @TeamBVotes</p>
    </div>
</div>

@code {
    // HubConnection for SignalR communication
    private HubConnection? _gameHubConnection;

    private string? SuccessMessage { get; set; }


    // Vote counts for each team
    private int TeamAVotes { get; set; }
    private int TeamBVotes { get; set; }

    // Player's chosen team
    private string PlayerTeam { get; set; } = "A"; // Default to Team A

    // Monster variables
    private string CorrectButton;
    private string MonsterMessage;
    private bool IsMonsterDefeated = false;
    private bool IsStunned = false;
    private int StunDuration = 3000; // 3 seconds stun duration

    // NavigationManager for URL navigation
    [Inject] private NavigationManager Navigation { get; set; } = null!;

    // Calculate the vote difference to shift the entire group (Team A, Rope, Team B)
    private int VoteDifference => TeamAVotes - TeamBVotes;

    // Use the vote difference to shift the entire group left or right
    private double PositionOffset => VoteDifference * -0.5;

    // ======= Minimal setup for testing SignalR connection =======
    protected override async Task OnInitializedAsync()
    {
        // Connect to the SignalR hub
        var gameStateUrl = _nav.ToAbsoluteUri("/tug-game");
        _gameHubConnection = new HubConnectionBuilder()
            .WithUrl(gameStateUrl)
            .WithAutomaticReconnect()
            .Build();

        // Listening for game state updates
        _gameHubConnection.On<TugGameEventArgs>("RecieveGameState", OnGameStateUpdate);

        try
        {
            await _gameHubConnection.StartAsync();
            await _gameHubConnection.InvokeAsync("AddToListenerGroup");

            // Start the monster spawning
            StartMonsterSpawn();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Connection failed: {ex.Message}");
        }

        await base.OnInitializedAsync();
    }

    // Handle game state update from server
    private void OnGameStateUpdate(TugGameEventArgs args)
    {
        TeamAVotes = args.TeamA;
        TeamBVotes = args.TeamB;
        InvokeAsync(StateHasChanged);
    }

    // Start the monster spawn loop
    private void StartMonsterSpawn()
    {
        Task.Run(async () =>
        {
            while (true)
            {
                await Task.Delay(5000); // New monster every 5 seconds
                RandomizeMonster();
                IsMonsterDefeated = false;
                IsStunned = false;
                SuccessMessage = null;
                InvokeAsync(StateHasChanged);
            }
        });
    }

    // Randomize the monster to appear above a button
    private void RandomizeMonster()
    {
        var buttons = new[] { "A", "B", "C" };
        CorrectButton = buttons[new Random().Next(0, buttons.Length)];
        MonsterMessage = $"A monster appears above button {CorrectButton}!";
    }

    // Handle button clicks
    private async Task ButtonClicked(string button)
    {
        if (button == CorrectButton)
        {
            // Correct button clicked, monster defeated
            IsMonsterDefeated = true;
            SuccessMessage = "You successfully struck the monster and got to the ballot box! That's a vote for your candidate!";
            await SubmitVote();
        }
        else
        {
            // Wrong button clicked, player gets stunned
            IsStunned = true;
            await Task.Delay(StunDuration);
            IsStunned = false;
        }
        InvokeAsync(StateHasChanged);
    }

    // Submit a vote after monster is defeated
    private async Task SubmitVote()
    {
        if (_gameHubConnection is not null)
        {
            if (PlayerTeam == "A")
            {
                await _gameHubConnection.InvokeAsync("TugLeft");
            }
            else if (PlayerTeam == "B")
            {
                await _gameHubConnection.InvokeAsync("TugRight");
            }
        }
    }

    // Handle monster positioning 
    private string GetMonsterPosition(string button)
    {
        // Logic to return the appropriate style for the monster's position
        return button switch
        {
            "A" => "position: absolute; top: 0; left: 10%;", // For button A
            "B" => "position: absolute; top: 0; left: 45%;", // For button B
            "C" => "position: absolute; top: 0; left: 80%;", // For button C
            _ => "position: absolute; top: 0; left: 0;", // Default position
        };
    }


    // Dispose connection
    public async ValueTask DisposeAsync()
    {
        if (_gameHubConnection is not null)
        {
            await _gameHubConnection.DisposeAsync();
        }
    }
}

<!-- Custom CSS TO BE MOVED ELSEWHERE -->
<style>
    .game-area {
        width: 100%;
        height: 200px;
        background-color: #f0f0f0;
        position: relative;
    }

    .team {
        position: absolute;
        bottom: 0;
    }

    .team-image {
        max-width: 150px;
    }

    .rope-image {
        max-width: 100px;
        position: absolute;
        bottom: 0;
    }

    .monster-area {
        margin-top: 2rem;
        height: 200px;
        position: relative;
    }

    .monster-image img {
        max-width: 100px;
    }

    .button-area {
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .vote-counts {
        font-size: 1.5rem;
    }
</style>
